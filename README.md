
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D Ï∫êÎ¶≠ÌÑ∞ HUD, Îã¨Î†• & ÎßêÌíçÏÑ† Ï±ÑÌåÖ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: Arial, sans-serif; overflow: hidden; }
    
    /* Ïò§Î•∏Ï™Ω Ï±ÑÌåÖÏ∞Ω */
    #right-hud {
      position: fixed;
      top: 10%;
      right: 1%;
      width: 20%;
      padding: 1%;
      background: rgba(255,255,255,0.8);
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 20;
    }
    #chat-log {
      display: none;
      height: 100px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      padding: 5px;
      margin-top: 10px;
      border-radius: 3px;
      background: #fff;
    }
    #chat-input-area {
      display: flex;
      margin-top: 10px;
    }
    #chat-input {
      flex: 1;
      padding: 5px;
      font-size: 14px;
    }
    
    /* ÏôºÏ™Ω Ï∫òÎ¶∞Îçî */
    #left-hud {
      position: fixed;
      top: 10%;
      left: 1%;
      width: 20%;
      padding: 1%;
      background: rgba(255,255,255,0.9);
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 20;
      max-height: 80vh;
      overflow-y: auto;
    }
    #left-hud h3 { margin-bottom: 5px; }
    #calendar-container { margin-top: 10px; }
    #calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    #calendar-header button { padding: 2px 6px; font-size: 12px; cursor: pointer; }
    #month-year-label { font-weight: bold; font-size: 14px; }
    #year-select { font-size: 12px; padding: 2px; margin-left: 5px; }
    #calendar-actions {
      margin-top: 5px;
      text-align: center;
    }
    #calendar-actions button {
      margin: 2px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    #calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    #calendar-grid div {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-height: 25px;
      font-size: 10px;
      padding: 2px;
      position: relative;
      cursor: pointer;
    }
    #calendar-grid div:hover { background: #e9e9e9; }
    .day-number {
      position: absolute;
      top: 2px;
      left: 2px;
      font-weight: bold;
      font-size: 10px;
    }
    .event {
      margin-top: 14px;
      font-size: 8px;
      color: #333;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Three.js Ï∫îÎ≤ÑÏä§ */
    #canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      display: block;
    }
    
    /* ÎßêÌíçÏÑ† */
    #speech-bubble {
      position: fixed;
      background: white;
      padding: 5px 10px;
      border-radius: 10px;
      font-size: 12px;
      display: none;
      z-index: 30;
      white-space: pre-line;
      pointer-events: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* ÌäúÌÜ†Î¶¨Ïñº Ïò§Î≤ÑÎ†àÏù¥ */
    #tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }
    #tutorial-content {
      text-align: center;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      max-width: 600px;
    }
    #tutorial-content h2 { margin-bottom: 15px; }
    #tutorial-content p { margin: 10px 0; font-size: 14px; }
    
    /* Î≤ÑÏ†Ñ ÏÑ†ÌÉù */
    #version-select {
      position: fixed;
      bottom: 10px;
      left: 10px;
      z-index: 50;
    }
    #version-select select {
      padding: 5px;
      font-size: 12px;
    }

    @media (max-width: 480px) {
      #right-hud, #left-hud { width: 90%; left: 5%; right: 5%; top: 5%; }
    }
  </style>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  
  <script>
    document.addEventListener("contextmenu", event => event.preventDefault());
    let blockUntil = 0;
    let danceInterval; // Ï∫êÎ¶≠ÌÑ∞ Ï∂§ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†úÏñ¥ Î≥ÄÏàò
    // currentCity: ÎÇ†Ïî® API Ìò∏Ï∂ú Ïãú ÏÇ¨Ïö©Îê† ÏßÄÏó≠Î™Ö (Ï¥àÍ∏∞Í∞í "Seoul")
    let currentCity = "Seoul";
    
    document.addEventListener("copy", function(e) {
      e.preventDefault();
      let selectedText = window.getSelection().toString();
      selectedText = selectedText.replace(/396bfaf4974ab9c336b3fb46e15242da/g, "HIDDEN");
      e.clipboardData.setData("text/plain", selectedText);
      if (Date.now() < blockUntil) return;
      blockUntil = Date.now() + 3600000;
      showSpeechBubbleInChunks("1ÏãúÍ∞ÑÎèôÏïà Ï∞®Îã®Îê©ÎãàÎã§.");
    });
    
    const weatherKey = "396bfaf4974ab9c336b3fb46e15242da";
    let currentWeather = "";
    
    function saveFile() {
      const content = "ÌååÏùº Ï†ÄÏû• ÏôÑÎ£å";
      const filename = "saved_file.txt";
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function saveCalendar() {
      const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
      const calendarData = {};
      for (let d = 1; d <= daysInMonth; d++){
        const eventDiv = document.getElementById(`event-${currentYear}-${currentMonth+1}-${d}`);
        if (eventDiv && eventDiv.textContent.trim() !== "") {
          calendarData[`${currentYear}-${currentMonth+1}-${d}`] = eventDiv.textContent;
        }
      }
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(calendarData, null, 2));
      const dlAnchorElem = document.createElement("a");
      dlAnchorElem.setAttribute("href", dataStr);
      dlAnchorElem.setAttribute("download", "calendar_events.json");
      dlAnchorElem.style.display = "none";
      document.body.appendChild(dlAnchorElem);
      dlAnchorElem.click();
      document.body.removeChild(dlAnchorElem);
    }
    
    async function sendChat() {
      const inputEl = document.getElementById("chat-input");
      const input = inputEl.value.trim();
      
      if (Date.now() < blockUntil) {
        showSpeechBubbleInChunks("1ÏãúÍ∞ÑÎèôÏïà Ï∞®Îã®Îê©ÎãàÎã§.");
        inputEl.value = "";
        return;
      }
      
      if (!input) return;
      
      let response = "";
      const lowerInput = input.toLowerCase();
      
      // ÏßÄÏó≠ Î≥ÄÍ≤Ω Î™ÖÎ†π Ï≤òÎ¶¨: "Ïù∏Ï≤ú Î∞îÍøîÏ§ò", "ÏÑúÏö∏Î°ú Î∞îÍøîÏ§ò" Îì±
      const regionPattern = /(ÏÑúÏö∏|Ïù∏Ï≤ú|ÌååÏ£º|Î∂ÄÏÇ∞|ÎåÄÍµ¨|Í¥ëÏ£º|ÎåÄÏ†Ñ|Ïö∏ÏÇ∞|Îã®Ïñë)(?:Î°ú)?\s*Î∞îÍøîÏ§ò/;
      if (regionPattern.test(lowerInput)) {
        const match = lowerInput.match(regionPattern);
        if(match && match[1]){
          currentCity = match[1];
          response = `ÏßÄÏó≠Ïù¥ ${match[1]}(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`;
          showSpeechBubbleInChunks(response);
          inputEl.value = "";
          return;
        }
      }
      
      // Í∏∞Ï°¥ "ÏßÄÏó≠ [ÏßÄÏó≠Î™Ö]" Î™ÖÎ†π Ï≤òÎ¶¨
      if (lowerInput.startsWith("ÏßÄÏó≠ ")) {
        const newCity = lowerInput.replace("ÏßÄÏó≠", "").trim();
        if(newCity) {
          if(newCity === "ÏàòÎèÑÍ∂å") {
            const selectedCity = prompt("ÏàòÎèÑÍ∂å ÏßÄÏó≠ Ï§ë ÏÑ†ÌÉùÌïòÏÑ∏Ïöî: Ïù∏Ï≤ú, ÏÑúÏö∏, ÌååÏ£º");
            if(selectedCity) {
              currentCity = selectedCity;
              response = `ÏßÄÏó≠Ïù¥ ${selectedCity}(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`;
            } else {
              response = "ÏßÄÏó≠ Î≥ÄÍ≤ΩÏù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.";
            }
          }
          else if(newCity === "ÏßÄÎ∞©") {
            const selectedCity = prompt("ÏßÄÎ∞© ÏßÄÏó≠ Ï§ë ÏÑ†ÌÉùÌïòÏÑ∏Ïöî: Î∂ÄÏÇ∞, ÎåÄÍµ¨, Í¥ëÏ£º");
            if(selectedCity) {
              currentCity = selectedCity;
              response = `ÏßÄÏó≠Ïù¥ ${selectedCity}(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`;
            } else {
              response = "ÏßÄÏó≠ Î≥ÄÍ≤ΩÏù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.";
            }
          }
          else {
            currentCity = newCity;
            response = `ÏßÄÏó≠Ïù¥ ${newCity}(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`;
          }
        } else {
          response = "Î≥ÄÍ≤ΩÌï† ÏßÄÏó≠ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
        }
      }
      else if (lowerInput.includes("ÏãúÍ∞Ñ") || lowerInput.includes("Î™áÏãú") || lowerInput.includes("ÌòÑÏû¨ÏãúÍ∞Ñ")) {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        response = `ÌòÑÏû¨ ÏãúÍ∞ÑÏùÄ ${hours}Ïãú ${minutes}Î∂ÑÏûÖÎãàÎã§.`;
      }
      else if (lowerInput.includes("ÌååÏùº Ï†ÄÏû•Ìï¥Ï§ò")) {
        response = "ÎÑ§, ÏïåÍ≤†ÏäµÎãàÎã§. ÌååÏùº Ï†ÄÏû•ÌïòÍ≤†ÏäµÎãàÎã§.";
        saveFile();
      }
      else if ((lowerInput.includes("Ï∫òÎ¶∞Îçî") && lowerInput.includes("Ï†ÄÏû•")) ||
               lowerInput.includes("ÏùºÏ†ïÏ†ÄÏû•") ||
               lowerInput.includes("ÌïòÎ£®ÏùºÍ≥ºÏ†ÄÏû•")) {
        response = "ÎÑ§, ÏïåÍ≤†ÏäµÎãàÎã§. Ï∫òÎ¶∞Îçî Ï†ÄÏû•ÌïòÍ≤†ÏäµÎãàÎã§.";
        saveCalendar();
      }
      else if (lowerInput.includes("ÎÇ†Ïî®") &&
         (lowerInput.includes("ÏïåÎ†§") || lowerInput.includes("Ïñ¥Îïå") ||
          lowerInput.includes("Î≠êÏïº") || lowerInput.includes("Ïñ¥ÎñªÍ≤å") || lowerInput.includes("ÎßëÏïÑ"))) {
        response = await getWeather();
      }
      else if (lowerInput.includes("Í∏∞Î∂Ñ") && lowerInput.includes("Ï¢ãÏïÑ")) {
        response = "Ï†ïÎßêÏöî!? Ï†ÄÎèÑ Ï†ïÎßê Í∏∞Î∂ÑÏ¢ãÏïÑÏöîüòÅ";
        const originalEyeColor = leftEye.material.color.getHex();
        leftEye.material.color.set(0xffff00);
        rightEye.material.color.set(0xffff00);
        setTimeout(() => {
          leftEye.material.color.set(originalEyeColor);
          rightEye.material.color.set(originalEyeColor);
        }, 500);
        const originalLeftBrowRotation = leftBrow.rotation.x;
        const originalRightBrowRotation = rightBrow.rotation.x;
        const eyebrowInterval = setInterval(() => {
          const angle = Math.sin(Date.now() * 0.005) * 0.3;
          leftBrow.rotation.x = originalLeftBrowRotation + angle;
          rightBrow.rotation.x = originalRightBrowRotation + angle;
        }, 50);
        setTimeout(() => {
          clearInterval(eyebrowInterval);
          leftBrow.rotation.x = originalLeftBrowRotation;
          rightBrow.rotation.x = originalRightBrowRotation;
        }, 3000);
      }
      else if (lowerInput.includes("ÏïàÎÖï")) {
        response = "ÏïàÎÖïÌïòÏÑ∏Ïöî, Ï£ºÏù∏Îãò! Ïò§Îäò Í∏∞Î∂ÑÏùÄ Ïñ¥Îñ†ÏÑ∏Ïöî?";
        characterGroup.children[7].rotation.z = Math.PI / 4;
        setTimeout(() => { characterGroup.children[7].rotation.z = 0; }, 1000);
      }
      else if (lowerInput.includes("Ï∫êÎ¶≠ÌÑ∞ ÎÑå ÎàÑÍµ¨Ïïº")) {
        response = "Ï†ÄÎäî ÎãπÏã†Ïùò Í∞úÏù∏ ÎπÑÏÑúÏóêÏöî.";
      }
      else if (lowerInput.includes("ÏùºÏ†ï")) {
        response = "Ï∫òÎ¶∞ÎçîÎäî ÏôºÏ™ΩÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.";
      }
      else if (lowerInput.includes("Ï∫êÎ¶≠ÌÑ∞ Ï∂§Ï∂∞Ï§ò")) {
        response = "Ï∂§Ï∂úÍ≤åÏöî!";
        if (danceInterval) clearInterval(danceInterval);
        danceInterval = setInterval(() => {
          characterGroup.children[7].rotation.z = Math.sin(Date.now() * 0.01) * Math.PI / 4;
          head.rotation.y = Math.sin(Date.now() * 0.01) * Math.PI / 8;
        }, 50);
        setTimeout(() => {
          clearInterval(danceInterval);
          characterGroup.children[7].rotation.z = 0;
          head.rotation.y = 0;
        }, 3000);
      }
      // Ï∂§ Í¥ÄÎ†® ÌÇ§ÏõåÎìú Ï≤òÎ¶¨
      else if (
        lowerInput.includes("Ï∂§") ||
        lowerInput.includes("Ï∂§Ï∂∞") ||
        lowerInput.includes("Ï∂§Ï∂∞Ï§ò") ||
        lowerInput.includes("Ï∂§Ï∂∞Î¥ê") ||
        lowerInput.includes("Ï∂§ÏÇ¨ÏúÑ")
      ) {
        response = "Ï∂§Ï∂îÍ≤†ÏäµÎãàÎã§! Ïû†ÏãúÎßå Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî.";
        if (danceInterval) clearInterval(danceInterval);
        danceInterval = setInterval(() => {
          characterGroup.children[7].rotation.z = Math.sin(Date.now() * 0.01) * Math.PI / 4;
          head.rotation.y = Math.sin(Date.now() * 0.01) * Math.PI / 8;
        }, 50);
        setTimeout(() => {
          clearInterval(danceInterval);
          characterGroup.children[7].rotation.z = 0;
          head.rotation.y = 0;
        }, 3000);
      }
      else if (lowerInput.includes("ÌïòÎ£®ÏùºÏ†ï ÏÇ≠Ï†úÌï¥Ï§ò") || lowerInput.includes("ÏùºÏ†ï ÏÇ≠Ï†ú")) {
        const dayStr = prompt("ÏÇ≠Ï†úÌï† ÌïòÎ£®ÏùºÏ†ïÏùò ÎÇ†Ïßú(Ïùº)Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: 15):");
        if (dayStr) {
          const dayNum = parseInt(dayStr);
          const eventDiv = document.getElementById(`event-${currentYear}-${currentMonth+1}-${dayNum}`);
          if (eventDiv) {
            eventDiv.textContent = "";
            response = `${currentYear}-${currentMonth+1}-${dayNum} ÏùºÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`;
          } else {
            response = "Ìï¥Îãπ ÎÇ†ÏßúÏùò ÏÖÄÏù¥ ÏóÜÏäµÎãàÎã§. ÌòÑÏû¨ Îã¨Ïóê ÏûàÎäî ÎÇ†ÏßúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
          }
        } else {
          response = "ÎÇ†ÏßúÎ•º ÏûÖÎ†•ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.";
        }
      }
      else if (lowerInput.includes("ÏûÖÎ†•ÌïòÍ≤å Î≥¥Ïó¨Ï§ò") || lowerInput.includes("ÏùºÏ†ï ÏûÖÎ†•")) {
        const dayStr = prompt("ÏùºÏ†ïÏùÑ ÏûÖÎ†•Ìï† ÎÇ†Ïßú(Ïùº)Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: 15):");
        if (dayStr) {
          const dayNum = parseInt(dayStr);
          const eventDiv = document.getElementById(`event-${currentYear}-${currentMonth+1}-${dayNum}`);
          if (eventDiv) {
            const eventText = prompt(`${currentYear}-${currentMonth+1}-${dayNum} ÏùºÏ†ï ÏûÖÎ†•:`);
            if (eventText) {
              if (eventDiv.textContent) {
                eventDiv.textContent += "; " + eventText;
              } else {
                eventDiv.textContent = eventText;
              }
              response = `${currentYear}-${currentMonth+1}-${dayNum}Ïóê ÏùºÏ†ïÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.`;
            } else {
              response = "ÏùºÏ†ïÏùÑ ÏûÖÎ†•ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.";
            }
          } else {
            response = "Ìï¥Îãπ ÎÇ†ÏßúÏùò ÏÖÄÏù¥ ÏóÜÏäµÎãàÎã§. ÌòÑÏû¨ Îã¨Ïóê ÏûàÎäî ÎÇ†ÏßúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
          }
        } else {
          response = "ÎÇ†ÏßúÎ•º ÏûÖÎ†•ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.";
        }
      }
      else {
        response = "Ï£ÑÏÜ°Ìï¥Ïöî, Ïûò Ïù¥Ìï¥ÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî. Îã§Ïãú Ìïú Î≤à ÎßêÏîÄÌï¥Ï£ºÏãúÍ≤†Ïñ¥Ïöî?";
      }
      
      showSpeechBubbleInChunks(response);
      inputEl.value = "";
    }
    
    // currentCity Í∏∞Î∞ò ÎÇ†Ïî® Ï°∞Ìöå (ÌÖçÏä§Ìä∏ Î™ÖÎ†πÏö©)
    async function getWeather() {
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${currentCity}&appid=${weatherKey}&units=metric&lang=kr`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("ÎÇ†Ïî® API Ìò∏Ï∂ú Ïã§Ìå®");
        const data = await res.json();
        const description = data.weather[0].description;
        const temp = data.main.temp;
        currentWeather = description;
        let extraComment = "";
        if (description.indexOf("ÌùêÎ¶º") !== -1 || description.indexOf("Íµ¨Î¶Ñ") !== -1) {
          extraComment = " Ïò§ÎäòÏùÄ ÏïΩÍ∞Ñ ÌùêÎ¶∞ ÎÇ†Ïî®ÎÑ§Ïöî ‚òÅÔ∏è";
        }
        return `Ïò§Îäò ${currentCity}Ïùò ÎÇ†Ïî®Îäî ${description}Ïù¥Î©∞, Ïò®ÎèÑÎäî ${temp}¬∞CÏûÖÎãàÎã§.${extraComment}`;
      } catch (err) {
        currentWeather = "";
        return "ÎÇ†Ïî® Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.";
      }
    }
    
    // ÏúÑÎèÑ/Í≤ΩÎèÑ Í∏∞Î∞ò ÎÇ†Ïî® Ï°∞Ìöå (ÎßêÌíçÏÑ† Ï∂úÎ†•)
    async function getWeatherByCoords(lat, lng) {
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${weatherKey}&units=metric&lang=kr`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("ÎÇ†Ïî® API Ìò∏Ï∂ú Ïã§Ìå®");
        const data = await res.json();
        const description = data.weather[0].description;
        const temp = data.main.temp;
        let extraComment = "";
        if (description.indexOf("ÌùêÎ¶º") !== -1 || description.indexOf("Íµ¨Î¶Ñ") !== -1) {
          extraComment = " Ïò§ÎäòÏùÄ ÏïΩÍ∞Ñ ÌùêÎ¶∞ ÎÇ†Ïî®ÎÑ§Ïöî ‚òÅÔ∏è";
        }
        const msg = `Ìï¥Îãπ ÏúÑÏπòÏùò ÎÇ†Ïî®Îäî ${description}, Ïò®ÎèÑÎäî ${temp}¬∞CÏûÖÎãàÎã§.${extraComment}`;
        showSpeechBubbleInChunks(msg);
      } catch (err) {
        showSpeechBubbleInChunks("ÎÇ†Ïî® Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
      }
    }
    
    function updateWeatherEffects() {
      if (currentWeather.indexOf("ÎπÑ") !== -1 || currentWeather.indexOf("ÏÜåÎÇòÍ∏∞") !== -1) {
        rainGroup.visible = true;
      } else {
        rainGroup.visible = false;
      }
      if (currentWeather.indexOf("Íµ¨Î¶Ñ") !== -1) {
        houseCloudGroup.visible = true;
      } else {
        houseCloudGroup.visible = false;
      }
    }
    
    function updateLightning() {
      if (currentWeather.indexOf("Î≤àÍ∞ú") !== -1 || currentWeather.indexOf("ÎáåÏö∞") !== -1) {
        if (Math.random() < 0.001) {
          lightningLight.intensity = 5;
          setTimeout(() => { lightningLight.intensity = 0; }, 100);
        }
      }
    }
    
    function showSpeechBubbleInChunks(text, chunkSize = 15, delay = 3000) {
      const bubble = document.getElementById("speech-bubble");
      const chunks = [];
      for (let i = 0; i < text.length; i += chunkSize) {
        chunks.push(text.slice(i, i + chunkSize));
      }
      let index = 0;
      function showNextChunk() {
        if (index < chunks.length) {
          bubble.textContent = chunks[index];
          bubble.style.display = "block";
          index++;
          setTimeout(showNextChunk, delay);
        } else {
          setTimeout(() => { bubble.style.display = "none"; }, 3000);
        }
      }
      showNextChunk();
    }
    
    window.addEventListener("DOMContentLoaded", function() {
      document.getElementById("chat-input").addEventListener("keydown", function(e) {
        if (e.key === "Enter") sendChat();
      });
    });
    
    window.addEventListener("resize", function(){
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</head>
<body>
  <div id="right-hud">
    <h3>Ï±ÑÌåÖÏ∞Ω</h3>
    <div id="chat-log"></div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Ï±ÑÌåÖ ÏûÖÎ†•..." />
    </div>
  </div>
  
  <div id="left-hud">
    <h3>Ï∫òÎ¶∞Îçî</h3>
    <div id="calendar-container">
      <div id="calendar-header">
        <button id="prev-month">‚óÄ</button>
        <span id="month-year-label"></span>
        <button id="next-month">‚ñ∂</button>
        <select id="year-select"></select>
      </div>
      <div id="calendar-actions">
        <button id="delete-day-event">ÌïòÎ£®ÏùºÏ†ï ÏÇ≠Ï†ú</button>
        <button id="save-calendar">Î∞îÌÉïÌôîÎ©¥ Ï†ÄÏû•</button>
      </div>
      <div id="calendar-grid"></div>
    </div>
  </div>
  
  <div id="speech-bubble"></div>
  
  <div id="tutorial-overlay">
    <div id="tutorial-content">
      <h2>ÏÇ¨Ïö©Î≤ï ÏïàÎÇ¥</h2>
      <p><strong>Ï∫êÎ¶≠ÌÑ∞:</strong> Ï±ÑÌåÖÏ∞ΩÏóê "ÏïàÎÖï", "Ï∫êÎ¶≠ÌÑ∞ Ï∂§Ï∂∞Ï§ò" Îì± ÏûÖÎ†•Ìï¥ Î≥¥ÏÑ∏Ïöî.</p>
      <p>
        <strong>Ï±ÑÌåÖÏ∞Ω:</strong> Ïò§Î•∏Ï™ΩÏóêÏÑú "ÎÇ†Ïî® ÏïåÎ†§Ï§ò", "ÌååÏùº Ï†ÄÏû•Ìï¥Ï§ò" Îì± Î™ÖÎ†πÌï† Ïàò ÏûàÏäµÎãàÎã§.<br>
        ÎòêÌïú, "ÏßÄÏó≠ [ÏßÄÏó≠Î™Ö]" (Ïòà: "ÏßÄÏó≠ ÏàòÎèÑÍ∂å" ÎòêÎäî "ÏßÄÏó≠ Î∂ÄÏÇ∞") ÎòêÎäî "Ïù∏Ï≤ú Î∞îÍøîÏ§ò", "ÏÑúÏö∏Î°ú Î∞îÍøîÏ§ò" Îì±<br>
        Î™ÖÎ†πÏñ¥Î•º ÏûÖÎ†•ÌïòÎ©¥ Ìï¥Îãπ ÏßÄÏó≠ÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏñ¥ Ïù¥ÌõÑ "ÎÇ†Ïî® ÏïåÎ†§Ï§ò" Î™ÖÎ†π Ïãú ÏóÖÎç∞Ïù¥Ìä∏Îêú ÏßÄÏó≠Ïùò ÎÇ†Ïî®Í∞Ä Ï°∞ÌöåÎê©ÎãàÎã§.
      </p>
      <p><strong>Ï∫òÎ¶∞Îçî:</strong> ÏôºÏ™ΩÏóêÏÑú ÎÇ†Ïßú ÌÅ¥Î¶≠Ìï¥ ÏùºÏ†ïÏùÑ Ï∂îÍ∞ÄÌïòÍ±∞ÎÇò, Î≤ÑÌäºÏúºÎ°ú Ï†ÄÏû•/ÏÇ≠Ï†úÌïòÏÑ∏Ïöî.</p>
    </div>
  </div>
  
  <div id="version-select">
    <select onchange="changeVersion(this.value)">
      <option value="latest">ÏµúÏã† Î≤ÑÏ†Ñ</option>
      <option value="1.3">Íµ¨Î≤ÑÏ†Ñ 1.3</option>
    </select>
  </div>
  
  <canvas id="canvas"></canvas>
</body>
</html>
